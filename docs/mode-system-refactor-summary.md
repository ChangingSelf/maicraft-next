# æ¨¡å¼ç³»ç»Ÿé‡æ„æ€»ç»“

## ğŸ¯ é‡æ„ç›®æ ‡

è§£å†³åŸç³»ç»Ÿä¸­æ¨¡å¼ç­–ç•¥ç³»ç»Ÿå­˜åœ¨çš„ä¸¥é‡é—®é¢˜ï¼š
- **æ­»å¾ªç¯é—®é¢˜**ï¼šç­–ç•¥ç³»ç»Ÿå’Œæ¨¡å¼ç³»ç»Ÿç›¸äº’è„±èŠ‚å¯¼è‡´å†³ç­–æ­»é”
- **å†³ç­–å¤±è´¥**ï¼šä¸»å¾ªç¯æ‰¾ä¸åˆ°å¯æ‰§è¡Œç­–ç•¥ï¼ŒæŒç»­ç©ºè½¬
- **æ¶æ„ç¼ºé™·**ï¼šè¿‡åº¦å·¥ç¨‹åŒ–ï¼ŒèŒè´£è¾¹ç•Œä¸æ¸…

## ğŸ“… é‡æ„æ—¶é—´

2025å¹´11æœˆ2æ—¥

## ğŸ”§ é‡æ„å†…å®¹

### 1. æ¶æ„ç®€åŒ–

**ç§»é™¤ç»„ä»¶**ï¼š
- âŒ `DecisionStrategyManager` - ç­–ç•¥ç®¡ç†å™¨
- âŒ `DecisionStrategy` æ¥å£åŠå®ç°
- âŒ `AutoModeSwitchStrategy`
- âŒ `LLMDecisionStrategy`
- âŒ `CombatStrategy`
- âŒ æ•´ä¸ª `src/core/agent/decision/` ç›®å½•

**ä¿ç•™æ ¸å¿ƒ**ï¼š
- âœ… `ModeManager` - å¢å¼ºç‰ˆæ¨¡å¼ç®¡ç†å™¨
- âœ… `BaseMode` - é‡æ„åçš„åŸºç±»
- âœ… `MainMode` - é‡æ„åçš„ä¸»æ¨¡å¼
- âœ… `CombatMode` - é‡æ„åçš„æˆ˜æ–—æ¨¡å¼

### 2. æ–°å¢ç»„ä»¶

**GameStateListener æ¥å£**ï¼š
```typescript
export interface GameStateListener {
  readonly listenerName: string;
  readonly enabled: boolean;

  onGameStateUpdated?(gameState: any, previousState?: any): Promise<void>;
  onEntitiesUpdated?(entities: any[]): Promise<void>;
  onBlocksUpdated?(blocks: any[]): Promise<void>;
  onInventoryUpdated?(inventory: any): Promise<void>;
  onHealthUpdated?(health: { health: number; food: number; saturation: number }): Promise<void>;
}
```

**é€‚é…åŸ maicraft çš„ç¯å¢ƒç›‘å¬å™¨æœºåˆ¶åˆ°æœ¬é¡¹ç›®çš„ GameState ç³»ç»Ÿ**

### 3. æ ¸å¿ƒæ¶æ„å˜æ›´

#### æ¨¡å¼ç®¡ç†å™¨å¢å¼º
```typescript
// æ–°å¢åŠŸèƒ½
async notifyGameStateUpdate(gameState: any): Promise<void>;
async forceRecoverToMain(reason: string): Promise<boolean>;
getTransitionHistory(): Array<{...}>;

// ç›‘å¬å™¨ç®¡ç†
private gameStateListeners: GameStateListener[] = [];
```

#### ä¸»å†³ç­–å¾ªç¯ç®€åŒ–
```typescript
// ç§»é™¤ç­–ç•¥ç®¡ç†å™¨ç›¸å…³ä»£ç 
- private strategyManager: DecisionStrategyManager;
- private registerStrategies();

// æ–°å¢æ¨¡å¼æ‰§è¡Œé€»è¾‘
async executeCurrentMode(): Promise<void>;
private async notifyGameStateUpdate(): Promise<void>;
private async adjustSleepDelay(): Promise<void>;
```

#### æ¨¡å¼åŸºç±»é‡æ„
```typescript
// çŠ¶æ€ç»‘å®š
bindState(state: AgentState): void {
  this.state = state;
}

// ç›‘å¬å™¨å®ç°
abstract class BaseMode implements GameStateListener

// ç”Ÿå‘½å‘¨æœŸç®¡ç†
abstract execute(): Promise<void>;
async checkTransitions(): Promise<string[]>;
```

## ğŸ® å…·ä½“å®ç°å˜æ›´

### MainMode (ä¸»æ¨¡å¼)
- **ç§»é™¤**ï¼šå¼‚æ­¥ä»»åŠ¡ã€ç­–ç•¥ä¾èµ–
- **æ–°å¢**ï¼šå®Œæ•´çš„ LLM å†³ç­–é€»è¾‘
- **ä¼˜åŒ–**ï¼šæ™ºèƒ½åŠ¨ä½œè§£æï¼ˆæ”¯æŒå¤šç§å­—æ®µåï¼‰
- **é›†æˆ**ï¼šæç¤ºè¯æ¨¡æ¿ã€æ•°æ®æ”¶é›†å™¨

### CombatMode (æˆ˜æ–—æ¨¡å¼)
- **é‡æ„**ï¼šå®ç° GameStateListener æ¥å£
- **æ–°å¢**ï¼šå®æ—¶å¨èƒæ£€æµ‹å’Œè‡ªåŠ¨åˆ‡æ¢
- **ä¼˜åŒ–**ï¼šæ”»å‡»å†·å´ã€ç›®æ ‡é”å®š
- **ç§»é™¤**ï¼šç‹¬ç«‹å¼‚æ­¥æˆ˜æ–—ä»»åŠ¡

### ModeManager (æ¨¡å¼ç®¡ç†å™¨)
- **æ–°å¢**ï¼šæ¸¸æˆçŠ¶æ€ç›‘å¬å™¨è°ƒåº¦
- **æ–°å¢**ï¼šæ¨¡å¼åˆ‡æ¢å†å²è®°å½•
- **æ–°å¢**ï¼šå¼ºåˆ¶æ¢å¤å®‰å…¨æœºåˆ¶
- **ä¼˜åŒ–**ï¼šç»Ÿä¸€æ¨¡å¼åˆ›å»ºå’ŒçŠ¶æ€ç»‘å®š

## ğŸ”„ é‡æ„å‰åå¯¹æ¯”

### é‡æ„å‰ï¼ˆé—®é¢˜æ¶æ„ï¼‰
```
MainDecisionLoop
â”œâ”€â”€ DecisionStrategyManager
â”‚   â”œâ”€â”€ AutoModeSwitchStrategy (æ€»æ˜¯æ‰§è¡Œ)
â”‚   â”œâ”€â”€ CombatStrategy (æ°¸è½®ä¸åˆ°)
â”‚   â””â”€â”€ LLMDecisionStrategy (æ°¸è½®ä¸åˆ°)
â””â”€â”€ æ¨¡å¼ç³»ç»Ÿ (ç‹¬ç«‹è¿è¡Œ)
    â”œâ”€â”€ MainMode (åªç®¡ç†çŠ¶æ€)
    â””â”€â”€ CombatMode (å¼‚æ­¥ä»»åŠ¡)
```

**é—®é¢˜**ï¼š
- ç­–ç•¥æ€»è¿”å› trueï¼Œæ‰§è¡Œåç«‹å³è¿”å›
- å¼‚æ­¥æˆ˜æ–—ä»»åŠ¡ä¸ä¸»å¾ªç¯è„±èŠ‚
- æ¨¡å¼åˆ‡æ¢ä½œä¸ºç­–ç•¥ï¼Œæ€»æ˜¯ä¼˜å…ˆæ‰§è¡Œ

### é‡æ„åï¼ˆç®€æ´æ¶æ„ï¼‰
```
MainDecisionLoop
â”œâ”€â”€ notifyGameStateUpdate() (çŠ¶æ€é€šçŸ¥)
â”œâ”€â”€ checkAutoTransitions() (æ¨¡å¼åˆ‡æ¢)
â”œâ”€â”€ executeCurrentMode() (æ¨¡å¼æ‰§è¡Œ)
â””â”€â”€ æ¨¡å¼ç³»ç»Ÿ (ç»Ÿä¸€ç®¡ç†)
    â”œâ”€â”€ MainMode (LLMå†³ç­– + çŠ¶æ€ç®¡ç†)
    â””â”€â”€ CombatMode (ç›‘å¬å™¨ + è‡ªåŠ¨æˆ˜æ–—)
```

**ä¼˜åŠ¿**ï¼š
- æ¨¡å¼ç›´æ¥åŒ…å«ä¸šåŠ¡é€»è¾‘
- æ‰€æœ‰é€»è¾‘åŒæ­¥æ‰§è¡Œ
- ç›‘å¬å™¨å®ç°å®æ—¶å“åº”

## ğŸ“Š è§£å†³çš„é—®é¢˜

### 1. æ­»å¾ªç¯é—®é¢˜ âœ…
**åŸå› **ï¼šç­–ç•¥ç³»ç»Ÿå’Œæ¨¡å¼ç³»ç»Ÿç›¸äº’å†²çª
**è§£å†³**ï¼šç§»é™¤ç­–ç•¥å±‚ï¼Œç»Ÿä¸€æ¨¡å¼é©±åŠ¨

### 2. å†³ç­–å¤±è´¥é—®é¢˜ âœ…
**åŸå› **ï¼šä¸»å¾ªç¯æ‰¾ä¸åˆ°å¯æ‰§è¡Œç­–ç•¥
**è§£å†³**ï¼šç›´æ¥æ‰§è¡Œå½“å‰æ¨¡å¼é€»è¾‘

### 3. å¼‚æ­¥è„±èŠ‚é—®é¢˜ âœ…
**åŸå› **ï¼šæˆ˜æ–—é€»è¾‘åœ¨åå°å¼‚æ­¥è¿è¡Œ
**è§£å†³**ï¼šæ‰€æœ‰é€»è¾‘é€šè¿‡æ¨¡å¼ç³»ç»ŸåŒæ­¥æ‰§è¡Œ

### 4. ç»„ä»¶ç¼ºå¤±é—®é¢˜ âœ…
**åŸå› **ï¼šBaseMode.bindState() ç©ºå®ç°
**è§£å†³**ï¼šæ­£ç¡®å®ç°çŠ¶æ€ç»‘å®šé€»è¾‘

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### æ™ºèƒ½ç­‰å¾…æ—¶é—´
- æˆ˜æ–—æ¨¡å¼ï¼š200msï¼ˆå¿«é€Ÿå“åº”ï¼‰
- ä¸»æ¨¡å¼ï¼š100msï¼ˆæ­£å¸¸é—´éš”ï¼‰
- å…¶ä»–æ¨¡å¼ï¼š500msï¼ˆé»˜è®¤é—´éš”ï¼‰

### ç»„ä»¶å¤ç”¨
- æ¨¡å¼å®ä¾‹å¯åŠ¨æ—¶åˆ›å»ºï¼Œé¿å…é‡å¤åˆå§‹åŒ–
- çŠ¶æ€ç›‘å¬å™¨è‡ªåŠ¨æ³¨å†Œ
- LLM ç»„ä»¶ç»Ÿä¸€ç®¡ç†

### å†…å­˜ä¼˜åŒ–
- ç§»é™¤ç­–ç•¥ç³»ç»Ÿå‡å°‘å†…å­˜å ç”¨
- æ¨¡å¼åˆ‡æ¢å†å²è‡ªåŠ¨æ¸…ç†
- ç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

## ğŸ§ª æµ‹è¯•ç»“æœ

### å¯åŠ¨æµ‹è¯• âœ…
```
[ModeManager] ğŸ“ æ³¨å†Œæ¨¡å¼...
[ModeManager]   - ä¸»æ¨¡å¼ (ä¼˜å…ˆçº§: 0)
[ModeManager]   - æˆ˜æ–—æ¨¡å¼ (ä¼˜å…ˆçº§: 100)
[ModeManager] ğŸ“¡ å·²æ³¨å†Œ 1 ä¸ªæ¸¸æˆçŠ¶æ€ç›‘å¬å™¨
[ModeManager] âœ… å·²æ³¨å†Œ 2 ä¸ªæ¨¡å¼
[ä¸»æ¨¡å¼] ğŸ”„ æ¿€æ´»æ¨¡å¼: ä¸»æ¨¡å¼ (åˆå§‹åŒ–)
[ModeManager] ğŸ”„ æ¨¡å¼åˆ‡æ¢: None â†’ ä¸»æ¨¡å¼ (åˆå§‹åŒ–)
```

### è¿è¡Œæµ‹è¯• âœ…
```
[ä¸»æ¨¡å¼] ğŸ¤– LLM å“åº”å®Œæˆ
[ä¸»æ¨¡å¼] ğŸ“‹ å‡†å¤‡æ‰§è¡Œ 1 ä¸ªåŠ¨ä½œ
[ä¸»æ¨¡å¼] ğŸ” è§£æçš„åŠ¨ä½œJSON: {"action_type": "mine_block", "name": "dirt", "count": 3}
[ä¸»æ¨¡å¼] ğŸ¬ æ‰§è¡ŒåŠ¨ä½œ 1/1: mine_block
[ä¸»æ¨¡å¼] âœ… åŠ¨ä½œ 1/1: æˆåŠŸ
```

### å¨èƒå“åº”æµ‹è¯• âœ…
```
[CombatMode] âš ï¸ æ£€æµ‹åˆ°å¨èƒ: zombie (è·ç¦»: 5.2m)
[ModeManager] ğŸ”„ æ¨¡å¼åˆ‡æ¢: ä¸»æ¨¡å¼ â†’ æˆ˜æ–—æ¨¡å¼ (æ£€æµ‹åˆ°å¨èƒç”Ÿç‰©: zombie)
[CombatMode] âš”ï¸ è¿›å…¥æˆ˜æ–—çŠ¶æ€
[CombatMode] âš”ï¸ æ”»å‡»ç›®æ ‡: zombie (è·ç¦»: 5.2m)
[CombatMode] âœ… æˆåŠŸå‡»æ€: zombie
[ModeManager] ğŸ”„ æ¨¡å¼åˆ‡æ¢: æˆ˜æ–—æ¨¡å¼ â†’ ä¸»æ¨¡å¼ (å¨èƒæ¶ˆé™¤)
```

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### 1. ç®€æ´æ€§
- ç§»é™¤äº†è¿‡åº¦å·¥ç¨‹åŒ–çš„ç­–ç•¥å±‚
- ç›´æ¥æ¨¡å¼é©±åŠ¨ï¼Œå‡å°‘æŠ½è±¡å±‚æ¬¡
- ä¿æŒåŸ maicraft çš„è®¾è®¡ç²¾é«“

### 2. ä¸€è‡´æ€§
- ç»Ÿä¸€çš„æ¨¡å¼é©±åŠ¨è®¾è®¡
- æ‰€æœ‰é€»è¾‘é€šè¿‡æ¨¡å¼ç³»ç»Ÿæ‰§è¡Œ
- çŠ¶æ€ç®¡ç†å’Œä¸šåŠ¡é€»è¾‘ç»Ÿä¸€

### 3. å“åº”æ€§
- åŸºäº GameStateListener çš„äº‹ä»¶é©±åŠ¨
- å®æ—¶å¨èƒæ£€æµ‹å’Œæ¨¡å¼åˆ‡æ¢
- æ— å»¶è¿Ÿçš„çŠ¶æ€å˜åŒ–å“åº”

### 4. å¯ç»´æŠ¤æ€§
- æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- å®Œæ•´çš„ç±»å‹å®‰å…¨
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

### 5. æ‰©å±•æ€§
- ç®€å•çš„æ¨¡å¼æ·»åŠ æœºåˆ¶
- çµæ´»çš„ç›‘å¬å™¨æ‰©å±•
- ç»Ÿä¸€çš„é…ç½®ç®¡ç†

## ğŸ“ è¿ç§»æŒ‡å—

### å¯¹äºå¼€å‘è€…
1. **ç§»é™¤ç­–ç•¥ç›¸å…³ä»£ç **ï¼šåˆ é™¤ DecisionStrategy ç›¸å…³å¼•ç”¨
2. **ä½¿ç”¨æ–°æ¨¡å¼ API**ï¼šå‚è€ƒ `docs/mode-system.md`
3. **æ›´æ–°åŠ¨ä½œè§£æ**ï¼šLLM å“åº”æ ¼å¼ä½¿ç”¨ `action_type` å­—æ®µ
4. **ç›‘å¬çŠ¶æ€å˜åŒ–**ï¼šå®ç° GameStateListener æ¥å£

### å¯¹äºç”¨æˆ·
- **æ— æ„ŸçŸ¥è¿ç§»**ï¼šç°æœ‰é…ç½®å’Œæç¤ºè¯æ— éœ€ä¿®æ”¹
- **åŠŸèƒ½å¢å¼º**ï¼šå¨èƒå“åº”æ›´åŠæ—¶ï¼Œå†³ç­–æ›´ç¨³å®š
- **æ€§èƒ½æå‡**ï¼šå‡å°‘èµ„æºå ç”¨ï¼Œæé«˜å“åº”é€Ÿåº¦

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡
- [ ] æ·»åŠ æ›´å¤šæ¸¸æˆæ¨¡å¼ï¼ˆGUIæ¨¡å¼ã€åˆæˆæ¨¡å¼ç­‰ï¼‰
- [ ] ä¼˜åŒ–åŠ¨ä½œè§£æçš„å®¹é”™æ€§
- [ ] å®Œå–„æ¨¡å¼åˆ‡æ¢çš„æ¡ä»¶åˆ¤æ–­

### é•¿æœŸç›®æ ‡
- [ ] å®ç°æ¨¡å¼çš„çƒ­æ’æ‹”
- [ ] æ·»åŠ æ¨¡å¼æ€§èƒ½ç›‘æ§
- [ ] æ”¯æŒè‡ªå®šä¹‰æ¨¡å¼é…ç½®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ¨¡å¼ç³»ç»Ÿæ¶æ„æ–‡æ¡£](./mode-system.md)
- [åŸé—®é¢˜ä¿®å¤æ–‡æ¡£](./fix-decision-loop-deadlock.md)
- [æ¶æ„æ¦‚è§ˆ](./architecture-overview.md)

---

**é‡æ„ç»“è®º**ï¼šæˆåŠŸè§£å†³äº†åŸç³»ç»Ÿçš„æ­»å¾ªç¯å’Œå†³ç­–å¤±è´¥é—®é¢˜ï¼Œå®ç°äº†ç®€æ´ã€é«˜æ•ˆã€å¯æ‰©å±•çš„æ¨¡å¼é©±åŠ¨æ¶æ„ï¼Œå®Œå…¨ç¬¦åˆåŸ maicraft é¡¹ç›®çš„è®¾è®¡ç†å¿µã€‚
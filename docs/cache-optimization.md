# 缓存优化方案

## 优化目标

1. **清除远距离旧缓存** - Bot移动后，旧位置的方块已无用
2. **增大缓存容量** - 支持更大范围的探索
3. **保持缓存高效** - 只保留附近有用的数据

## 实现方案

### 1. 新增 clearOutOfRange 方法 (BlockCache.ts)

```typescript
clearOutOfRange(centerX: number, centerY: number, centerZ: number, maxDistance: number): number
```

**功能**：清除超出指定距离的方块缓存

**参数**：

- `centerX, centerY, centerZ`: 中心位置（通常是bot当前位置）
- `maxDistance`: 最大保留距离（格数）

**返回**：清除的方块数量

### 2. 扫描时清理旧缓存 (CacheManager.ts)

```typescript
// 扫描完成后，清除100格外的旧方块
const removedCount = this.blockCache.clearOutOfRange(
  centerPos.x,
  centerPos.y,
  centerPos.z,
  100, // 保留100格范围内的缓存
);
```

**时机**：每次扫描完成后立即清理

**范围策略**：

- 扫描半径：20格
- 保留范围：100格（5倍扫描半径）
- 定期清理：150格（在自动保存时执行）

### 3. 定期清理机制

```typescript
private cleanupExpiredCache(): void {
  // 每5分钟（自动保存时）清理150格外的缓存
  this.blockCache.clearOutOfRange(currentPos.x, currentPos.y, currentPos.z, 150);
}
```

### 4. 增大缓存容量

| 配置项         | 旧值   | 新值       | 说明                    |
| -------------- | ------ | ---------- | ----------------------- |
| maxEntries     | 10,000 | **50,000** | 5倍容量，支持大范围探索 |
| expirationTime | 60分钟 | **30分钟** | 缩短过期时间，加快清理  |

## 缓存清理策略

### 三层清理机制

```
┌─────────────────────────────────────┐
│     扫描范围: 20格                   │
│  ┌──────────────────────────────┐   │
│  │   保留范围: 100格             │   │
│  │ ┌─────────────────────────┐  │   │
│  │ │  定期清理: 150格         │  │   │
│  │ │                         │  │   │
│  │ │      Bot (中心)         │  │   │
│  │ │                         │  │   │
│  │ └─────────────────────────┘  │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘

- 扫描时: 清除 >100格 的方块
- 定期(5分钟): 清除 >150格 的方块
- 过期(30分钟): 自动清除旧数据
```

### 清理时机

1. **每次扫描后**（5秒间隔）
   - 清除超过100格的方块
   - 保持缓存集中在当前区域

2. **自动保存时**（5分钟间隔）
   - 清除超过150格的方块
   - 定期深度清理

3. **缓存满时**（达到50,000条）
   - 自动驱逐最旧的10%条目
   - 避免内存溢出

## 性能影响

### 内存使用

**优化前**：

```
- 最大容量: 10,000 方块
- 实际使用: ~9,000 方块（包含大量远距离旧数据）
- 预估内存: ~5MB
```

**优化后**：

```
- 最大容量: 50,000 方块
- 实际使用: ~15,000 方块（只保留100格内有效数据）
- 预估内存: ~8MB（但数据更有效）
```

### 扫描性能

**clearOutOfRange 性能**：

```typescript
// 时间复杂度: O(n) - 遍历所有缓存
// 对于 15,000 个方块: ~5-10ms
// 执行频率: 每5秒一次
// 影响: 可忽略
```

## 效果对比

### Before（无清理机制）

```
缓存大小: 9,082 个方块
问题:
- 包含很远位置的旧数据
- 查询当前位置找不到方块
- 缓存利用率低
```

### After（有清理机制）

```
✅ 扫描完成: 已缓存 1200 个, 清理 7800 个旧方块, 当前缓存总数: 1500
效果:
- 缓存集中在当前位置100格内
- 查询命中率高
- 内存使用更高效
```

## 配置建议

### 不同场景的配置

**探索模式**（频繁移动）

```typescript
blockScanRadius: 20,      // 扫描范围
保留范围: 100格,           // 5倍扫描半径
定期清理: 150格,           // 1.5倍保留范围
maxEntries: 50000,        // 大容量
```

**建造模式**（固定区域）

```typescript
blockScanRadius: 30,      // 更大扫描
保留范围: 200格,           // 保留更多
定期清理: 300格,           // 延迟清理
maxEntries: 100000,       // 超大容量
```

**战斗模式**（快速移动）

```typescript
blockScanRadius: 15,      // 快速扫描
保留范围: 50格,            // 快速清理
定期清理: 80格,            // 激进清理
maxEntries: 20000,        // 中等容量
```

## 监控指标

### 关键日志

```
✅ 扫描完成: 总检查 15000, 已缓存 1200 个, 清理 500 个旧方块, 当前缓存总数: 2300
```

**观察指标**：

1. **清理数量**：如果持续清理大量方块，说明bot在快速移动
2. **当前总数**：应该保持在合理范围（10,000-20,000）
3. **缓存命中**：查询时应该能找到方块

### 异常情况

**缓存持续增长**

```
当前缓存总数: 45000 → 48000 → 50000
问题: 清理不及时或保留范围过大
解决: 减小保留范围或增加清理频率
```

**频繁清理大量方块**

```
清理 8000 个旧方块 → 清理 7500 个旧方块
问题: Bot移动速度过快
解决: 增大保留范围或降低扫描频率
```

## 总结

### 优化收益

1. ✅ **缓存更有效** - 只保留附近有用的数据
2. ✅ **查询更快** - 减少无效数据遍历
3. ✅ **内存可控** - 自动清理避免溢出
4. ✅ **支持大范围** - 容量提升到50,000

### 权衡考虑

- **清理开销**：每5秒~10ms（可接受）
- **保留范围**：100格是5倍扫描半径（合理）
- **容量上限**：50,000足够大多数场景

### 未来优化方向

1. **智能保留**：保留重要方块（箱子、矿石）即使超出范围
2. **分区缓存**：按区块(chunk)组织，提高清理效率
3. **压缩存储**：对远距离数据使用压缩格式
4. **优先级队列**：重要区域优先保留

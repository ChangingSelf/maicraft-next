# 规划系统提示词适配说明

## 问题诊断

用户发现了提示词系统与规划系统不匹配的问题：

### 旧提示词的问题

1. **包含不存在的动作**：
   - `edit_task_list` - 用于编辑任务列表
   - `complete_goal` - 用于完成目标
   - 这些动作在 `ActionIds.ts` 中**根本不存在**

2. **任务管理理念冲突**：
   - 旧提示词：要求 LLM 手动管理任务状态
   - 新规划系统：自动追踪任务进度（通过 Tracker）

3. **混淆 LLM 职责**：
   - LLM 被告知要"编辑任务列表"、"更新任务进展"
   - 但实际上新系统是全自动的

## 新规划系统的工作原理

### 1. Goal-Plan-Task 层次结构

```
Goal (目标)
  └─ Plan (计划) - LLM 自动生成
      └─ Task (任务) - 包含自动追踪器
          └─ Tracker (追踪器) - 自动检测完成状态
```

### 2. 自动化流程

```
LLM 执行动作 (mine_block, craft, etc.)
  ↓
Tracker 检测游戏状态变化
  ↓
任务自动标记为完成
  ↓
自动切换到下一个任务
```

### 3. LLM 的职责

**旧系统（错误）**：

- ❌ 手动编辑任务列表
- ❌ 更新任务进度
- ❌ 选择下一个任务

**新系统（正确）**：

- ✅ 查看当前目标和任务
- ✅ 理解任务要求
- ✅ 执行动作来完成任务
- ✅ 系统自动追踪和切换

## 提示词更新内容

### 1. 移除不存在的动作

**删除**：

```
**进入task_edit模式**
对任务列表进行修改...
"action_type":"edit_task_list"

如果目标已经完成...
"action_type":"complete_goal"
```

**替换为**：

```
**关于规划系统**
系统会自动管理目标和任务：
- 你的目标会被自动分解为具体的执行计划和任务
- 每个任务都有自动追踪器，当你完成相关动作后会自动标记为完成
- 任务完成后系统会自动切换到下一个任务
- 你只需要专注执行动作来完成当前任务，不需要手动管理任务状态
```

### 2. 更新行为准则

**旧版本**：

```
3. task_edit可以帮助你规划当前任务并保持专注。
```

**新版本**：

```
3. 专注于当前任务，通过执行动作来完成任务目标。任务完成会被自动检测
5. 查看"当前目标和任务列表"来了解你需要做什么，当前任务的进度如何
```

### 3. 优化基础信息展示

**旧版本**：

```
**当前目标和任务列表**：
目标：{goal}
任务列表：
{to_do_list}
```

**新版本**：

```
**当前目标和任务规划**
目标：{goal}

{to_do_list}

说明：任务系统会自动追踪你的进度，完成后会自动切换到下一个任务。
你只需要专注执行动作来完成当前任务的目标。
```

## 数据传递流程

### 规划信息如何传递给 LLM

```typescript
// PromptDataCollector.ts
collectBasicInfo(): BasicInfoData {
  return {
    goal: this.state.goal,
    to_do_list: planningManager?.generateStatusSummary() || '暂无任务',
    // ... 其他字段
  };
}
```

### generateStatusSummary() 输出格式

```
🎯 当前目标: 建造一个简单的木屋

📋 获取木材和工具 (2/5)
  ⏳ 收集橡木原木 (60%)
  ⏳ 合成木板
  ⏳ 制作工作台
  ⏳ 制作木镐
  ⏳ 收集圆石

🔄 当前任务: 收集橡木原木
   进度: 6/10 oak_log
   完成条件: 背包中至少有 10 个 oak_log
   📊 执行统计: 8/10 成功 (80%)
```

### LLM 看到的完整提示词

```
你是AI Bot，游戏名叫Bot,你正在游玩1.18.5以上版本的Minecraft。
生命值: 20/20, 饥饿值: 18/20

**当前目标和任务规划**
目标：建造一个简单的木屋

🎯 当前目标: 建造一个简单的木屋
📋 获取木材和工具 (1/5)
  🔄 收集橡木原木 (60%)
  ⏳ 合成木板
  ...

说明：任务系统会自动追踪你的进度，完成后会自动切换到下一个任务。
你只需要专注执行动作来完成当前任务的目标。

**当前状态**
...

**关于规划系统**
系统会自动管理目标和任务：
- 你的目标会被自动分解为具体的执行计划和任务
- 每个任务都有自动追踪器，当你完成相关动作后会自动标记为完成
- 任务完成后系统会自动切换到下一个任务
- 你只需要专注执行动作来完成当前任务，不需要手动管理任务状态
```

## 动作系统 vs 规划系统

### 它们的关系

| 系统         | 职责             | LLM 的角色                 |
| ------------ | ---------------- | -------------------------- |
| **动作系统** | 执行具体游戏操作 | LLM 选择和调用动作         |
| **规划系统** | 管理目标和任务   | LLM 只需查看，系统自动管理 |

### 为什么没有冗余？

1. **动作系统**：
   - 提供 15 个具体的游戏操作（move, mine_block, craft 等）
   - 在 ActionSchema 中定义参数
   - LLM 必须**主动调用**这些动作

2. **规划系统**：
   - 提供高层次的目标和任务信息
   - 告诉 LLM "应该做什么"和"进度如何"
   - LLM **被动接收**信息，不需要调用

3. **协同工作**：
   ```
   规划系统：当前任务是"收集10个橡木原木" (进度: 6/10)
   LLM 思考：我需要找到并挖掘橡木
   动作系统：LLM 调用 mine_block("oak_log", 4)
   游戏执行：挖掘橡木原木
   规划系统：自动检测到背包中有10个原木，任务完成！
   ```

## 回答用户的问题

### Q1: 提示词里面进行了规划系统的适配吗？

**A**: 之前**没有**完全适配。旧提示词包含不存在的 `edit_task_list` 和 `complete_goal` 动作。现在已修复。

### Q2: 动作参数是在 ActionSchema 里面吗？

**A**: **是的**。所有动作的参数都在 `ActionSchema.ts` 的 `ACTION_RESPONSE_SCHEMA` 中定义，使用 JSON Schema 的 `oneOf` 来为每个动作指定不同的参数。

### Q3: LLM 如何操作任务？

**A**: **LLM 不需要操作任务**。LLM 只需要：

- 查看当前任务和进度（通过 `to_do_list`）
- 执行相关动作来完成任务（通过动作系统）
- 系统会自动检测任务完成并切换

### Q4: LLM 如何得知目标、计划、当前任务？

**A**: 通过 `basic_info` 模板中的 `to_do_list` 字段：

```typescript
to_do_list: planningManager.generateStatusSummary();
```

这会生成包含目标、计划进度、当前任务和进度的详细摘要。

### Q5: LLM 如何编辑它们？

**A**: **LLM 不能也不需要编辑**。规划系统是完全自动的：

- Goal 由用户或系统设置
- Plan 由 LLM 一次性生成（在没有计划时）
- Task 的完成由 Tracker 自动检测
- 任务切换由系统自动完成

### Q6: 如果动作里已包含任务管理，是不是不需要冗余提示词？

**A**: **不冗余，它们各司其职**：

- **动作系统**：LLM 的"手"，用来执行操作
- **规划系统**：LLM 的"导航"，告诉它应该做什么

类比：

- 动作 = 驾驶操作（油门、刹车、方向盘）
- 规划 = GPS 导航（告诉你要去哪里，还有多远）

## 总结

### 修复前后对比

| 方面         | 修复前                           | 修复后                    |
| ------------ | -------------------------------- | ------------------------- |
| 任务管理动作 | ❌ edit_task_list, complete_goal | ✅ 已移除（不存在的动作） |
| LLM 职责     | ❌ 手动管理任务                  | ✅ 专注执行动作           |
| 规划系统说明 | ❌ 没有说明自动追踪              | ✅ 明确说明自动化         |
| 提示词清晰度 | ❌ 混淆                          | ✅ 清晰                   |

### 关键要点

1. ✅ **规划系统完全自动化** - LLM 不需要也不能手动管理
2. ✅ **LLM 只负责执行动作** - 通过动作系统完成任务目标
3. ✅ **动作和规划互补** - 动作是"手"，规划是"导航"
4. ✅ **提示词已更新** - 移除不存在的动作，添加规划系统说明
